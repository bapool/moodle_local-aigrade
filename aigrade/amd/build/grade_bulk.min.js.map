{"version":3,"file":"grade_bulk.min.js","sources":["../src/grade_bulk.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for AI Grade bulk grading button\n *\n * @module     local_aigrade/grade_bulk\n * @copyright  2025 Brian A. Pool, National Trail Local Schools\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str'], function($, Ajax, Notification, Str) {\n\n    return {\n        /**\n         * Initialize the grade bulk button\n         * @param {int} cmid The course module ID\n         * @param {string} buttonText The text to display on the button\n         */\n        init: function(cmid, buttonText) {\n\n            var insertButton = function() {\n                // Don't insert if button already exists\n                if ($('.aigrade-button-injected').length > 0) {\n                    return true;\n                }\n\n                // Create the button\n                var button = $('<button>')\n                    .attr('type', 'button')\n                    .addClass('btn btn-primary aigrade-button-injected')\n                    .text(buttonText)\n                    .on('click', function() {\n                        var btn = $(this);\n                        var originalText = btn.text();\n\n                        Str.get_strings([\n                            {key: 'confirm_bulk_grade', component: 'local_aigrade'},\n                            {key: 'grading_in_progress', component: 'local_aigrade'},\n                            {key: 'success_graded_count', component: 'local_aigrade'},\n                            {key: 'error_with_message', component: 'local_aigrade'},\n                            {key: 'error_unknown', component: 'local_aigrade'},\n                            {key: 'error_server_communication', component: 'local_aigrade'}\n                        ]).done(function(strings) {\n                            if (!confirm(strings[0])) {\n                                return;\n                            }\n\n                            btn.prop('disabled', true).text(strings[1]);\n\n                            Ajax.call([{\n                                methodname: 'local_aigrade_grade_bulk',\n                                args: {\n                                    cmid: cmid\n                                }\n                            }])[0].done(function(response) {\n                                if (response.success) {\n                                    Notification.addNotification({\n                                        message: strings[2].replace('{$a}', response.count),\n                                        type: 'success'\n                                    });\n                                    window.location.reload();\n                                } else {\n                                    var errorMsg = response.error || strings[4];\n                                    Notification.addNotification({\n                                        message: strings[3].replace('{$a}', errorMsg),\n                                        type: 'error'\n                                    });\n                                    btn.prop('disabled', false).text(originalText);\n                                }\n                            }).fail(function(error) {\n                                var errorMsg = error.message || strings[4];\n                                Notification.addNotification({\n                                    message: strings[5].replace('{$a}', errorMsg),\n                                    type: 'error'\n                                });\n                                btn.prop('disabled', false).text(originalText);\n                            });\n                        }).fail(function() {\n                            // Fallback if string fetch fails - use English defaults\n                            if (!confirm('Grade all ungraded submissions with AI? This may take a few moments.')) {\n                                return;\n                            }\n\n                            btn.prop('disabled', true).text('Grading all submissions...');\n\n                            Ajax.call([{\n                                methodname: 'local_aigrade_grade_bulk',\n                                args: {\n                                    cmid: cmid\n                                }\n                            }])[0].done(function(response) {\n                                if (response.success) {\n                                    alert('Successfully graded ' + response.count + ' submission(s).');\n                                    window.location.reload();\n                                } else {\n                                    alert('Error: ' + (response.error || 'Unknown error occurred'));\n                                    btn.prop('disabled', false).text(originalText);\n                                }\n                            }).fail(function(error) {\n                                alert('Error communicating with server: ' + (error.message || 'Unknown error'));\n                                btn.prop('disabled', false).text(originalText);\n                            });\n                        });\n                    });\n\n                // Try multiple insertion points\n                var inserted = false;\n\n                // Option 1: Tertiary navigation (preferred in Moodle 4.x)\n                if ($('.tertiary-navigation').length) {\n                    $('.tertiary-navigation').first().prepend($('<div>').css('display', 'inline-block').append(button));\n                    inserted = true;\n                }\n\n                // Option 2: After page header\n                if (!inserted && $('#page-header').length) {\n                    $('#page-header').first().after($('<div>').addClass('alert alert-info').css('margin', '15px').append(button));\n                    inserted = true;\n                }\n\n                // Option 3: Prepend to page content\n                if (!inserted && $('#page-content').length) {\n                    $('#page-content').prepend($('<div>').addClass('alert alert-info').css('margin', '15px').append(button));\n                    inserted = true;\n                }\n\n                return inserted;\n            };\n\n            // Wait for DOM to be ready, then try to insert\n            $(document).ready(function() {\n                // Try immediately\n                var inserted = insertButton();\n\n                // If not inserted, set up interval checking\n                if (!inserted) {\n                    var checkCount = 0;\n                    var maxChecks = 10; // Check for 5 seconds\n\n                    var insertInterval = setInterval(function() {\n                        checkCount++;\n                        if (insertButton() || checkCount >= maxChecks) {\n                            clearInterval(insertInterval);\n                        }\n                    }, 500);\n                }\n            });\n\n            // Also try on window load as backup\n            $(window).on('load', function() {\n                insertButton();\n            });\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","init","cmid","buttonText","insertButton","length","button","attr","addClass","text","on","btn","this","originalText","get_strings","key","component","done","strings","confirm","prop","call","methodname","args","response","success","addNotification","message","replace","count","type","window","location","reload","errorMsg","error","fail","alert","inserted","first","prepend","css","append","after","document","ready","checkCount","insertInterval","setInterval","clearInterval"],"mappings":";;;;;;;AAuBAA,kCAAO,CAAC,SAAU,YAAa,oBAAqB,aAAa,SAASC,EAAGC,KAAMC,aAAcC,WAEtF,CAMHC,KAAM,SAASC,KAAMC,gBAEbC,aAAe,cAEXP,EAAE,4BAA4BQ,OAAS,SAChC,MAIPC,OAAST,EAAE,YACVU,KAAK,OAAQ,UACbC,SAAS,2CACTC,KAAKN,YACLO,GAAG,SAAS,eACLC,IAAMd,EAAEe,MACRC,aAAeF,IAAIF,OAEvBT,IAAIc,YAAY,CACZ,CAACC,IAAK,qBAAsBC,UAAW,iBACvC,CAACD,IAAK,sBAAuBC,UAAW,iBACxC,CAACD,IAAK,uBAAwBC,UAAW,iBACzC,CAACD,IAAK,qBAAsBC,UAAW,iBACvC,CAACD,IAAK,gBAAiBC,UAAW,iBAClC,CAACD,IAAK,6BAA8BC,UAAW,mBAChDC,MAAK,SAASC,SACRC,QAAQD,QAAQ,MAIrBP,IAAIS,KAAK,YAAY,GAAMX,KAAKS,QAAQ,IAExCpB,KAAKuB,KAAK,CAAC,CACPC,WAAY,2BACZC,KAAM,CACFrB,KAAMA,SAEV,GAAGe,MAAK,SAASO,aACbA,SAASC,QACT1B,aAAa2B,gBAAgB,CACzBC,QAAST,QAAQ,GAAGU,QAAQ,OAAQJ,SAASK,OAC7CC,KAAM,YAEVC,OAAOC,SAASC,aACb,KACCC,SAAWV,SAASW,OAASjB,QAAQ,GACzCnB,aAAa2B,gBAAgB,CACzBC,QAAST,QAAQ,GAAGU,QAAQ,OAAQM,UACpCJ,KAAM,UAEVnB,IAAIS,KAAK,YAAY,GAAOX,KAAKI,kBAEtCuB,MAAK,SAASD,WACTD,SAAWC,MAAMR,SAAWT,QAAQ,GACxCnB,aAAa2B,gBAAgB,CACzBC,QAAST,QAAQ,GAAGU,QAAQ,OAAQM,UACpCJ,KAAM,UAEVnB,IAAIS,KAAK,YAAY,GAAOX,KAAKI,qBAEtCuB,MAAK,WAECjB,QAAQ,0EAIbR,IAAIS,KAAK,YAAY,GAAMX,KAAK,8BAEhCX,KAAKuB,KAAK,CAAC,CACPC,WAAY,2BACZC,KAAM,CACFrB,KAAMA,SAEV,GAAGe,MAAK,SAASO,UACbA,SAASC,SACTY,MAAM,uBAAyBb,SAASK,MAAQ,mBAChDE,OAAOC,SAASC,WAEhBI,MAAM,WAAab,SAASW,OAAS,2BACrCxB,IAAIS,KAAK,YAAY,GAAOX,KAAKI,kBAEtCuB,MAAK,SAASD,OACbE,MAAM,qCAAuCF,MAAMR,SAAW,kBAC9DhB,IAAIS,KAAK,YAAY,GAAOX,KAAKI,wBAM7CyB,UAAW,SAGXzC,EAAE,wBAAwBQ,SAC1BR,EAAE,wBAAwB0C,QAAQC,QAAQ3C,EAAE,SAAS4C,IAAI,UAAW,gBAAgBC,OAAOpC,SAC3FgC,UAAW,IAIVA,UAAYzC,EAAE,gBAAgBQ,SAC/BR,EAAE,gBAAgB0C,QAAQI,MAAM9C,EAAE,SAASW,SAAS,oBAAoBiC,IAAI,SAAU,QAAQC,OAAOpC,SACrGgC,UAAW,IAIVA,UAAYzC,EAAE,iBAAiBQ,SAChCR,EAAE,iBAAiB2C,QAAQ3C,EAAE,SAASW,SAAS,oBAAoBiC,IAAI,SAAU,QAAQC,OAAOpC,SAChGgC,UAAW,GAGRA,UAIXzC,EAAE+C,UAAUC,OAAM,eAECzC,mBAIP0C,WAAa,EAGbC,eAAiBC,aAAY,WAC7BF,cACI1C,gBAAkB0C,YAJV,KAKRG,cAAcF,kBAEnB,QAKXlD,EAAEkC,QAAQrB,GAAG,QAAQ,WACjBN"}