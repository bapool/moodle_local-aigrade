{"version":3,"file":"grade_single.min.js","sources":["../src/grade_single.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for AI Grade single submission button\n *\n * @module     local_aigrade/grade_single\n * @copyright  2025 Brian A. Pool, National Trail Local Schools\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery'], function($) {\n\n    return {\n        /**\n         * Initialize the grade single button\n         * @param {string} buttonUrl The URL for the AJAX request\n         * @param {string} buttonText The text to display on the button\n         * @param {string} sesskey The session key\n         */\n        init: function(buttonUrl, buttonText, sesskey) {\n\n            var insertButton = function() {\n                // Don't insert if button already exists\n                if ($('.aigrade-single-button').length > 0) {\n                    return true;\n                }\n\n                // Create the button\n                var button = $('<button>')\n                    .attr('type', 'button')\n                    .addClass('btn btn-primary aigrade-single-button')\n                    .text(buttonText)\n                    .data('force-regrade', false)\n                    .on('click', function() {\n                        var btn = $(this);\n                        var originalText = btn.text();\n                        var forceRegrade = btn.data('force-regrade');\n\n                        btn.prop('disabled', true).text('Grading...');\n\n                        // Get userid from current page URL\n            var urlParams = new URLSearchParams(window.location.search);\n            var currentUserid = urlParams.get('userid');\n\n            var url = buttonUrl.replace('userid=0', 'userid=' + currentUserid) + '&action=grade&sesskey=' + sesskey;\n                        if (forceRegrade) {\n                            url += '&force_regrade=1';\n                        }\n\n                        $.ajax({\n                            url: url,\n                            method: 'POST',\n                            dataType: 'json',\n                            success: function(response) {\n                                if (response.success) {\n                                    window.location.reload();\n                                } else if (response.already_graded) {\n                                    // Submission is already graded\n                                    btn.prop('disabled', false);\n                                    btn.text('Regrade with AI');\n                                    btn.removeClass('btn-primary').addClass('btn-warning');\n                                    btn.data('force-regrade', true);\n\n                                    if (confirm('This submission is already graded. Do you want to regrade it with AI?')) {\n                                        // User confirmed, trigger another click\n                                        btn.click();\n                                    }\n                                } else {\n                                    var errorMsg = response.error || 'Unknown error occurred';\n                                    alert('Error: ' + errorMsg);\n                                    btn.prop('disabled', false).text(originalText);\n                                }\n                            },\n                            error: function(xhr, status, error) {\n                                alert('Error communicating with server: ' + error);\n                                btn.prop('disabled', false).text(originalText);\n                            }\n                        });\n                    });\n\n                var container = $('<div>')\n                    .addClass('local_aigrade-button-container')\n                    .append(button);\n\n                // Try multiple insertion points in order of preference\n                var inserted = false;\n\n                // Option 1: After grade input row (preferred - puts it right after the grade field)\n                var gradeInput = $('input[name=\"grade\"]');\n                if (gradeInput.length) {\n                    var gradeRow = gradeInput.closest('.row, .fitem');\n                    if (gradeRow.length) {\n                        gradeRow.after(container);\n                        inserted = true;\n                    }\n                }\n\n                // Option 2: Before feedback section (if grade input not found)\n                if (!inserted) {\n                    var feedbackSection = $('div[id*=\"fitem_id_assignfeedbackcomments\"]');\n                    if (feedbackSection.length) {\n                        feedbackSection.before(container);\n                        inserted = true;\n                    }\n                }\n\n                // Option 3: Inside grade panel\n                if (!inserted) {\n                    var gradePanel = $('[data-region=\"grade-panel\"]');\n                    if (gradePanel.length) {\n                        gradePanel.prepend(container);\n                        inserted = true;\n                    }\n                }\n\n                // Option 4: Fallback to main content area\n                if (!inserted) {\n                    var mainContent = $('#region-main-box, #region-main, [role=\"main\"]').first();\n                    if (mainContent.length) {\n                        mainContent.prepend(container);\n                        inserted = true;\n                    }\n                }\n\n                return inserted;\n            };\n\n            // Try immediately when script loads\n            setTimeout(insertButton, 100);\n\n            // Wait for DOM to be ready\n            $(document).ready(function() {\n                setTimeout(insertButton, 100);\n            });\n\n            // Wait for full page load\n            $(window).on('load', function() {\n                setTimeout(insertButton, 200);\n            });\n\n            // Set up MutationObserver to watch for dynamic content\n            var observer = new MutationObserver(function() {\n                insertButton();\n            });\n\n            // Start observing the document body for changes\n            observer.observe(document.body, {\n                childList: true,\n                subtree: true\n            });\n\n            // Also re-insert after AJAX requests complete\n            $(document).ajaxComplete(function() {\n                setTimeout(insertButton, 100);\n            });\n\n            // Periodic checking as final fallback\n            var checkCount = 0;\n            var checkInterval = setInterval(function() {\n                checkCount++;\n                if (insertButton() || checkCount >= 20) {\n                    clearInterval(checkInterval);\n                }\n            }, 500);\n        }\n    };\n});\n"],"names":["define","$","init","buttonUrl","buttonText","sesskey","insertButton","length","button","attr","addClass","text","data","on","btn","this","originalText","forceRegrade","prop","currentUserid","URLSearchParams","window","location","search","get","url","replace","ajax","method","dataType","success","response","reload","already_graded","removeClass","confirm","click","errorMsg","error","alert","xhr","status","container","append","inserted","gradeInput","gradeRow","closest","after","feedbackSection","before","gradePanel","prepend","mainContent","first","setTimeout","document","ready","MutationObserver","observe","body","childList","subtree","ajaxComplete","checkCount","checkInterval","setInterval","clearInterval"],"mappings":";;;;;;;AAuBAA,oCAAO,CAAC,WAAW,SAASC,SAEjB,CAOHC,KAAM,SAASC,UAAWC,WAAYC,aAE9BC,aAAe,cAEXL,EAAE,0BAA0BM,OAAS,SAC9B,MAIPC,OAASP,EAAE,YACVQ,KAAK,OAAQ,UACbC,SAAS,yCACTC,KAAKP,YACLQ,KAAK,iBAAiB,GACtBC,GAAG,SAAS,eACLC,IAAMb,EAAEc,MACRC,aAAeF,IAAIH,OACnBM,aAAeH,IAAIF,KAAK,iBAE5BE,IAAII,KAAK,YAAY,GAAMP,KAAK,kBAIxCQ,cADY,IAAIC,gBAAgBC,OAAOC,SAASC,QACtBC,IAAI,UAE9BC,IAAMtB,UAAUuB,QAAQ,WAAY,UAAYP,eAAiB,yBAA2Bd,QAChFY,eACAQ,KAAO,oBAGXxB,EAAE0B,KAAK,CACHF,IAAKA,IACLG,OAAQ,OACRC,SAAU,OACVC,QAAS,SAASC,aACVA,SAASD,QACTT,OAAOC,SAASU,cACb,GAAID,SAASE,eAEhBnB,IAAII,KAAK,YAAY,GACrBJ,IAAIH,KAAK,mBACTG,IAAIoB,YAAY,eAAexB,SAAS,eACxCI,IAAIF,KAAK,iBAAiB,GAEtBuB,QAAQ,0EAERrB,IAAIsB,YAEL,KACCC,SAAWN,SAASO,OAAS,yBACjCC,MAAM,UAAYF,UAClBvB,IAAII,KAAK,YAAY,GAAOP,KAAKK,gBAGzCsB,MAAO,SAASE,IAAKC,OAAQH,OACzBC,MAAM,oCAAsCD,OAC5CxB,IAAII,KAAK,YAAY,GAAOP,KAAKK,oBAK7C0B,UAAYzC,EAAE,SACbS,SAAS,kCACTiC,OAAOnC,QAGRoC,UAAW,EAGXC,WAAa5C,EAAE,0BACf4C,WAAWtC,OAAQ,KACfuC,SAAWD,WAAWE,QAAQ,gBAC9BD,SAASvC,SACTuC,SAASE,MAAMN,WACfE,UAAW,OAKdA,SAAU,KACPK,gBAAkBhD,EAAE,8CACpBgD,gBAAgB1C,SAChB0C,gBAAgBC,OAAOR,WACvBE,UAAW,OAKdA,SAAU,KACPO,WAAalD,EAAE,+BACfkD,WAAW5C,SACX4C,WAAWC,QAAQV,WACnBE,UAAW,OAKdA,SAAU,KACPS,YAAcpD,EAAE,iDAAiDqD,QACjED,YAAY9C,SACZ8C,YAAYD,QAAQV,WACpBE,UAAW,UAIZA,UAIXW,WAAWjD,aAAc,KAGzBL,EAAEuD,UAAUC,OAAM,WACdF,WAAWjD,aAAc,QAI7BL,EAAEoB,QAAQR,GAAG,QAAQ,WACjB0C,WAAWjD,aAAc,QAId,IAAIoD,kBAAiB,WAChCpD,kBAIKqD,QAAQH,SAASI,KAAM,CAC5BC,WAAW,EACXC,SAAS,IAIb7D,EAAEuD,UAAUO,cAAa,WACrBR,WAAWjD,aAAc,YAIzB0D,WAAa,EACbC,cAAgBC,aAAY,WAC5BF,cACI1D,gBAAkB0D,YAAc,KAChCG,cAAcF,iBAEnB"}