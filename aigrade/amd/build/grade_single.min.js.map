{"version":3,"file":"grade_single.min.js","sources":["../src/grade_single.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * AMD module for AI Grade single submission button\n *\n * @module     local_aigrade/grade_single\n * @copyright  2025 Brian A. Pool, National Trail Local Schools\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'core/str'], function($, Ajax, Str) {\n    return {\n        /**\n         * Initialize the grade single button\n         * @param {int} cmid The course module ID\n         * @param {int} userid The user ID of the student\n         * @param {string} buttonText The text to display on the button\n         */\n        init: function(cmid, userid, buttonText) {\n            var insertButton = function() {\n                // Don't insert if button already exists\n                if ($('.aigrade-single-button').length > 0) {\n                    return true;\n                }\n                // Create the button\n                var button = $('<button>')\n                    .attr('type', 'button')\n                    .addClass('btn btn-primary aigrade-single-button')\n                    .text(buttonText)\n                    .on('click', function() {\n                        var btn = $(this);\n                        var originalText = btn.text();\n\n                        Str.get_strings([\n                            {key: 'grading_single_in_progress', component: 'local_aigrade'},\n                            {key: 'error_with_message', component: 'local_aigrade'},\n                            {key: 'error_unknown', component: 'local_aigrade'},\n                            {key: 'error_server_communication', component: 'local_aigrade'}\n                        ]).done(function(strings) {\n                            btn.prop('disabled', true).text(strings[0]);\n\n                            Ajax.call([{\n                                methodname: 'local_aigrade_grade_single',\n                                args: {\n                                    cmid: cmid,\n                                    userid: userid\n                                }\n                            }])[0].done(function(response) {\n                                if (response.success) {\n                                    window.location.reload();\n                                } else {\n                                    var errorMsg = response.error || strings[2];\n                                    alert(strings[1].replace('{$a}', errorMsg));\n                                    btn.prop('disabled', false).text(originalText);\n                                }\n                            }).fail(function(error) {\n                                var errorMsg = error.message || strings[2];\n                                alert(strings[3].replace('{$a}', errorMsg));\n                                btn.prop('disabled', false).text(originalText);\n                            });\n                        }).fail(function() {\n                            // Fallback if string fetch fails - use English defaults\n                            btn.prop('disabled', true).text('Grading...');\n\n                            Ajax.call([{\n                                methodname: 'local_aigrade_grade_single',\n                                args: {\n                                    cmid: cmid,\n                                    userid: userid\n                                }\n                            }])[0].done(function(response) {\n                                if (response.success) {\n                                    window.location.reload();\n                                } else {\n                                    var errorMsg = response.error || 'Unknown error occurred';\n                                    alert('Error: ' + errorMsg);\n                                    btn.prop('disabled', false).text(originalText);\n                                }\n                            }).fail(function(error) {\n                                alert('Error communicating with server: ' + (error.message || 'Unknown error'));\n                                btn.prop('disabled', false).text(originalText);\n                            });\n                        });\n                    });\n                var container = $('<div>')\n                    .addClass('local_aigrade-button-container')\n                    .append(button);\n                // Try multiple insertion points in order of preference\n                var inserted = false;\n                // Option 1: After grade input row (preferred - puts it right after the grade field)\n                var gradeInput = $('input[name=\"grade\"]');\n                if (gradeInput.length) {\n                    var gradeRow = gradeInput.closest('.row, .fitem');\n                    if (gradeRow.length) {\n                        gradeRow.after(container);\n                        inserted = true;\n                    }\n                }\n                // Option 2: Before feedback section (if grade input not found)\n                if (!inserted) {\n                    var feedbackSection = $('div[id*=\"fitem_id_assignfeedbackcomments\"]');\n                    if (feedbackSection.length) {\n                        feedbackSection.before(container);\n                        inserted = true;\n                    }\n                }\n                // Option 3: Inside grade panel\n                if (!inserted) {\n                    var gradePanel = $('[data-region=\"grade-panel\"]');\n                    if (gradePanel.length) {\n                        gradePanel.prepend(container);\n                        inserted = true;\n                    }\n                }\n                // Option 4: Fallback to main content area\n                if (!inserted) {\n                    var mainContent = $('#region-main-box, #region-main, [role=\"main\"]').first();\n                    if (mainContent.length) {\n                        mainContent.prepend(container);\n                        inserted = true;\n                    }\n                }\n                return inserted;\n            };\n            // Try immediately when script loads\n            setTimeout(insertButton, 100);\n            // Wait for DOM to be ready\n            $(document).ready(function() {\n                setTimeout(insertButton, 100);\n            });\n            // Wait for full page load\n            $(window).on('load', function() {\n                setTimeout(insertButton, 200);\n            });\n            // Set up MutationObserver to watch for dynamic content\n            var observer = new MutationObserver(function() {\n                insertButton();\n            });\n            // Start observing the document body for changes\n            observer.observe(document.body, {\n                childList: true,\n                subtree: true\n            });\n            // Also re-insert after AJAX requests complete\n            $(document).ajaxComplete(function() {\n                setTimeout(insertButton, 100);\n            });\n            // Periodic checking as final fallback\n            var checkCount = 0;\n            var checkInterval = setInterval(function() {\n                checkCount++;\n                if (insertButton() || checkCount >= 20) {\n                    clearInterval(checkInterval);\n                }\n            }, 500);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Str","init","cmid","userid","buttonText","insertButton","length","button","attr","addClass","text","on","btn","this","originalText","get_strings","key","component","done","strings","prop","call","methodname","args","response","success","window","location","reload","errorMsg","error","alert","replace","fail","message","container","append","inserted","gradeInput","gradeRow","closest","after","feedbackSection","before","gradePanel","prepend","mainContent","first","setTimeout","document","ready","MutationObserver","observe","body","childList","subtree","ajaxComplete","checkCount","checkInterval","setInterval","clearInterval"],"mappings":";;;;;;;AAqBAA,oCAAO,CAAC,SAAU,YAAa,aAAa,SAASC,EAAGC,KAAMC,WACnD,CAOHC,KAAM,SAASC,KAAMC,OAAQC,gBACrBC,aAAe,cAEXP,EAAE,0BAA0BQ,OAAS,SAC9B,MAGPC,OAAST,EAAE,YACVU,KAAK,OAAQ,UACbC,SAAS,yCACTC,KAAKN,YACLO,GAAG,SAAS,eACLC,IAAMd,EAAEe,MACRC,aAAeF,IAAIF,OAEvBV,IAAIe,YAAY,CACZ,CAACC,IAAK,6BAA8BC,UAAW,iBAC/C,CAACD,IAAK,qBAAsBC,UAAW,iBACvC,CAACD,IAAK,gBAAiBC,UAAW,iBAClC,CAACD,IAAK,6BAA8BC,UAAW,mBAChDC,MAAK,SAASC,SACbP,IAAIQ,KAAK,YAAY,GAAMV,KAAKS,QAAQ,IAExCpB,KAAKsB,KAAK,CAAC,CACPC,WAAY,6BACZC,KAAM,CACFrB,KAAMA,KACNC,OAAQA,WAEZ,GAAGe,MAAK,SAASM,aACbA,SAASC,QACTC,OAAOC,SAASC,aACb,KACCC,SAAWL,SAASM,OAASX,QAAQ,GACzCY,MAAMZ,QAAQ,GAAGa,QAAQ,OAAQH,WACjCjB,IAAIQ,KAAK,YAAY,GAAOV,KAAKI,kBAEtCmB,MAAK,SAASH,WACTD,SAAWC,MAAMI,SAAWf,QAAQ,GACxCY,MAAMZ,QAAQ,GAAGa,QAAQ,OAAQH,WACjCjB,IAAIQ,KAAK,YAAY,GAAOV,KAAKI,oBAEtCmB,MAAK,WAEJrB,IAAIQ,KAAK,YAAY,GAAMV,KAAK,cAEhCX,KAAKsB,KAAK,CAAC,CACPC,WAAY,6BACZC,KAAM,CACFrB,KAAMA,KACNC,OAAQA,WAEZ,GAAGe,MAAK,SAASM,aACbA,SAASC,QACTC,OAAOC,SAASC,aACb,KACCC,SAAWL,SAASM,OAAS,yBACjCC,MAAM,UAAYF,UAClBjB,IAAIQ,KAAK,YAAY,GAAOV,KAAKI,kBAEtCmB,MAAK,SAASH,OACbC,MAAM,qCAAuCD,MAAMI,SAAW,kBAC9DtB,IAAIQ,KAAK,YAAY,GAAOV,KAAKI,uBAI7CqB,UAAYrC,EAAE,SACbW,SAAS,kCACT2B,OAAO7B,QAER8B,UAAW,EAEXC,WAAaxC,EAAE,0BACfwC,WAAWhC,OAAQ,KACfiC,SAAWD,WAAWE,QAAQ,gBAC9BD,SAASjC,SACTiC,SAASE,MAAMN,WACfE,UAAW,OAIdA,SAAU,KACPK,gBAAkB5C,EAAE,8CACpB4C,gBAAgBpC,SAChBoC,gBAAgBC,OAAOR,WACvBE,UAAW,OAIdA,SAAU,KACPO,WAAa9C,EAAE,+BACf8C,WAAWtC,SACXsC,WAAWC,QAAQV,WACnBE,UAAW,OAIdA,SAAU,KACPS,YAAchD,EAAE,iDAAiDiD,QACjED,YAAYxC,SACZwC,YAAYD,QAAQV,WACpBE,UAAW,UAGZA,UAGXW,WAAW3C,aAAc,KAEzBP,EAAEmD,UAAUC,OAAM,WACdF,WAAW3C,aAAc,QAG7BP,EAAE4B,QAAQf,GAAG,QAAQ,WACjBqC,WAAW3C,aAAc,QAGd,IAAI8C,kBAAiB,WAChC9C,kBAGK+C,QAAQH,SAASI,KAAM,CAC5BC,WAAW,EACXC,SAAS,IAGbzD,EAAEmD,UAAUO,cAAa,WACrBR,WAAW3C,aAAc,YAGzBoD,WAAa,EACbC,cAAgBC,aAAY,WAC5BF,cACIpD,gBAAkBoD,YAAc,KAChCG,cAAcF,iBAEnB"}